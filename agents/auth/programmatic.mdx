---
title: "Programmatic Flow"
description: "Build your own credential collection UI with full control"
---

Build your own credential collection UI instead of using the hosted page. Poll for login fields, then submit credentials via the API.

Use the Programmatic flow when:
- You need a custom credential collection UI that matches your app's design
- You're building headless/automated authentication
- You have credentials stored and want to authenticate without user interaction

## How It Works

<Steps>
  <Step title="Create Auth Agent and Start Authentication">
    Same as [Hosted UI](/agents/auth/hosted-ui)
  </Step>
  <Step title="Wait for Login Fields">
    Poll until `step` becomes `awaiting_input`
  </Step>
  <Step title="Submit Credentials">
    Call `submit()` with the field values
  </Step>
  <Step title="Handle 2FA">
    If more fields appear (2FA code), submit again
  </Step>
</Steps>

## Getting started

### 1. Create an Auth Agent

```typescript
const agent = await kernel.agents.auth.create({
  domain: 'github.com',
  profile_name: 'github-profile',
});
```

### 2. Start Authentication

```typescript
const invocation = await kernel.agents.auth.invocations.create({
  auth_agent_id: agent.id,
});
```

To save credentials for automatic re-authentication:

```typescript
const invocation = await kernel.agents.auth.invocations.create({
  auth_agent_id: agent.id,
  save_credential_as: 'my-saved-creds',
});
```

### 3. Wait for Login Fields

Poll until the login fields are ready:

```typescript
let state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id);

while (state.status === 'IN_PROGRESS' && state.step !== 'awaiting_input') {
  await new Promise(r => setTimeout(r, 2000));
  state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id);
}

// state.pending_fields contains the login form fields
console.log('Fields:', state.pending_fields);
```

### 4. Submit Credentials

Match your credentials to the field names and submit:

```typescript
// Example pending_fields: [{ name: 'username', type: 'text' }, { name: 'password', type: 'password' }]

await kernel.agents.auth.invocations.submit(
  invocation.invocation_id,
  { 
    field_values: { 
      username: 'my-username', 
      password: 'my-password' 
    } 
  }
);
```

### 5. Handle 2FA

If the site asks for a 2FA code, `step` returns to `awaiting_input` with new fields:

```typescript
state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id);

while (state.status === 'IN_PROGRESS') {
  if (state.step === 'awaiting_input' && state.pending_fields?.length) {
    // New fields needed (e.g., 2FA code)
    const code = await promptUserForCode();
    
    await kernel.agents.auth.invocations.submit(
      invocation.invocation_id,
      { field_values: { [state.pending_fields[0].name]: code } }
    );
  }
  
  await new Promise(r => setTimeout(r, 2000));
  state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id);
}

if (state.status === 'SUCCESS') {
  console.log('Authentication successful!');
}
```

## Complete Example

<CodeGroup>
```typescript TypeScript
import Kernel from '@onkernel/sdk';

const kernel = new Kernel();

// Create auth agent
const agent = await kernel.agents.auth.create({
  domain: 'github.com',
  profile_name: 'github-profile',
});

const invocation = await kernel.agents.auth.invocations.create({
  auth_agent_id: agent.id,
});

// Wait for fields
let state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id);

while (state.status === 'IN_PROGRESS' && state.step !== 'awaiting_input') {
  await new Promise(r => setTimeout(r, 2000));
  state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id);
}

if (state.step === 'awaiting_input' && state.pending_fields) {
  // Submit credentials
  await kernel.agents.auth.invocations.submit(
    invocation.invocation_id,
    { 
      field_values: { 
        username: 'my-username', 
        password: 'secretpassword' 
      } 
    }
  );

  // Poll for completion, handle 2FA if needed
  state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id);
  
  while (state.status === 'IN_PROGRESS') {
    if (state.step === 'awaiting_input' && state.pending_fields?.length) {
      // 2FA required
      const code = await promptUserForCode();
      await kernel.agents.auth.invocations.submit(
        invocation.invocation_id,
        { field_values: { [state.pending_fields[0].name]: code } }
      );
    }

    await new Promise(r => setTimeout(r, 2000));
    state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id);
  }

  if (state.status === 'SUCCESS') {
    console.log('Authentication successful!');
  }
}
```

```python Python
from kernel import Kernel
import asyncio

kernel = Kernel()

# Create auth agent
agent = await kernel.agents.auth.create(
    domain="github.com",
    profile_name="github-profile",
)

invocation = await kernel.agents.auth.invocations.create(
    auth_agent_id=agent.id,
)

# Wait for fields
state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id)

while state.status == "IN_PROGRESS" and state.step != "awaiting_input":
    await asyncio.sleep(2)
    state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id)

if state.step == "awaiting_input" and state.pending_fields:
    # Submit credentials
    await kernel.agents.auth.invocations.submit(
        invocation.invocation_id,
        field_values={
            "username": "my-username",
            "password": "my-password",
        },
    )

    # Poll for completion, handle 2FA if needed
    state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id)
    
    while state.status == "IN_PROGRESS":
        if state.step == "awaiting_input" and state.pending_fields:
            # 2FA required
            code = input("Enter 2FA code: ")
            await kernel.agents.auth.invocations.submit(
                invocation.invocation_id,
                field_values={state.pending_fields[0].name: code},
            )

        await asyncio.sleep(2)
        state = await kernel.agents.auth.invocations.retrieve(invocation.invocation_id)

    if state.status == "SUCCESS":
        print("Authentication successful!")
```
</CodeGroup>
